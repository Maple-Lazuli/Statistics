---
title: "Unit 1 Project"
author: "Ada Lazuli"
output: html_document
date: 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Front Matter
```{r, warning=FALSE, message=FALSE}
remove(list = ls()) 

library(tidyverse)
library(GGally) 
library(gridExtra) 
library(factoextra) 
library(broom) 
library(mclust)
library(ggrepel)
library(reactable) 

setwd("/home/maple-power/CodeProjects/Statistics/STAT508/notebooks")
scores_full <- read.csv("/home/maple-power/CodeProjects/Statistics/STAT508/sample_data/STAT508_CODGamesP1.csv")
```

## Task 1


#### Data Description

Starting by becoming familar with the data available:

```{r}
reactable(scores_full, searchable = TRUE, compact = TRUE, striped = TRUE, defaultPageSize = 5, showPageSizeOptions = TRUE)
```
The data consists of 12 features. The first feature is the level or map the match occurred on. 

```{r}
table(scores_full$Level)
length(table(scores_full$Level))
```

The level feature is qualitative with 25 distinct levels being captured in the data. Not all of the levels are equally represented, however. 

The second feature is `FullPartial`, which describes whether the player played for the full duration of the match. 

```{r}
table(scores_full$FullPartial)
```

Based on the results of the table function, it appears that there is very severe class imbalance, with the vast majority of the observations consisting of 
players who completed a full match.

The third through ninth variables are quantitative and represent:

1. The score of the player's team.
2. The score of the opposing team.
3. The number of eliminations the player achieved.
4. The number of deaths the player experienced.
5. The score of the player during the match.
6. The damage dealt by the player.
7. The experience earned by the player during the match.

```{r, message=FALSE}
scores_num_long <- scores_full %>%
  select(-Level, -FullPartial, -XPType, -Mode, -Game) %>%
  pivot_longer(cols = 1: 7,
               names_to = "Metric",
               values_to = "Value")
ggplot(scores_num_long, aes(x = Value)) + 
  facet_wrap( ~ Metric, scales = "free_x") +
  geom_histogram(alpha = 0.5) +
  labs(x = "Count", y = "Performance Metric", subtitle = "Series of Boxplots Comparing Performance Metrics")
```

The damage dealt by the players is usually below 1000, but there are rare occasions where players deal over 4000 points of damage. Both the deaths and eliminations range
from zero to approximately 40, with the majority of the deaths and eliminations being below 20.

The player team and opponent team score metrics typically range from 50 to 100, with 100 being the most common score. Interestingly, there are some instances where
the scores go as high as 250. This effect might be due to the game mode played.

The score metric and totalXP metrics are both unimodal with right skews.

```{r}
scores_summary <- scores_num_long %>%
  group_by(Metric) %>%
  summarise(
    "Min" = round(min(Value), digits = 3),
    "Q1" = quantile(Value, .25)[[1]],
    "Median" = round(median(Value), digits = 3),
    "Q3" = quantile(Value, .75)[[1]],
    "IQR" = quantile(Value, .75)[[1]] - quantile(Value, .25)[[1]],
    "Max" = round(max(Value), digits = 3),
    "Mean" = round(mean(Value), digits = 3),
    "Standard Deviation" = round(sd(Value), digits = 3),
  )
reactable(scores_summary)
```

The tenth feature is qualitative and captures whether the match was serving regular or double experience. 

```{r}
table(scores_full$XPType)
```

Based on the table function, there is a roughly even split between matches with regular or double experience.

The eleventh feature is also qualitative and records whether the match was core or hardcore. The key distinction with hardcore is that players have a smaller
health pool and lose the ability to regerate health. This could have a consequence of affecting the damage dealt by players due to having less "spongy" opponents to attack.

```{r}
table(scores_full$Mode)
```

The table function shows that there is significant class imbalance, with the vast majority of the games being the hardcore variant. 

Lastly, the twelfth feature is qualitative and captures the game mode, such as "death match" or "hardpoint".

```{r}
table(scores_full$Game)
```

The table shows that the majority of the games in the data are for "Team Death Match"

```{r fig.width=10, fig.height=10}
ggpairs(data = scores_full, columns = 3:9, progress = FALSE) +
  theme(axis.ticks = element_blank(),
        axis.text = element_blank())
```

Based on the bivariate plots, the largest correlation is between score and eliminations. Unsurprisingly, there is a high correlation between player deaths and 
opponent team score.

#### Discussion 
During the initial data description, a few questions for further research were developed. The first is related to total experience and the game mode. It is
known that different game modes have different team score limits. Furthermore, the bivarate plot showed that the correlation between team scores and total experience was 
low. Therefore, it should follow that the the game modes with their different team score limits should not affect the total experience. The first research question
is whether the data supports this conclusion.

To attempt to answer this, a series of box plots capturing the distribution of total experience by game mode will be used.


```{r}
ggplot(scores_full, aes(x = TotalXP, y = Game, color = Game)) + 
  geom_boxplot(alpha = .5) +
  labs(x = "Total Experience", y = "Game Type", subtitle = "Boxplots Comparing Game Type and Experience")
```

Based on the boxplots, it seems that the total experience gained by the players in each game mode is similar. Notably, the largest difference in total experience
is between Domination and Team Death Match, but there are only 4 observations for Domination matches more data needs to be collected to determine whether there
is an actual difference.

The second research question raised during the initial data description was whether players deal more damage in "Core" as suspected and whether that would results in "Core"
matches leading to higher experience due to correlation of .382 between damage and total experience.

```{r}
ggplot(scores_full, aes(x = Damage, y = Mode, color = Mode)) + 
  geom_boxplot(alpha = .5) +
  labs(x = "Damage", y = "Game Mode", subtitle = "Boxplots Comparing Game Mode and Damage")
```
As expected, players deal more damage in core mode compared to hardcore mode.

```{r}
ggplot(scores_full, aes(x = TotalXP, y = Mode, color = Mode)) + 
  geom_boxplot(alpha = .5) +
  labs(x = "Total Experience", y = "Game Mode", subtitle = "Boxplots Comparing Game Mode and Total Experience")
```
Interestingly, despite the correlation between damage and experience, there is significant overlap between the total experience players earn in the different game modes. 
The dreadful Simpson's paradox would have manifested had the previous boxplot illustrated a different conclusion.

The final research question is whether the XPType of "double" actually results in double experience as the name would suggest. During the data description it was found
that roughly half of the matches were labeled "double". This would lead to the expectation that the total experience feature is bi-modal, however it was observed to be
uni-modal.

To answer this question, a pair of box plots will be used.

```{r}
ggplot(scores_full, aes(x = TotalXP, y = XPType, color = XPType)) + 
  geom_boxplot(alpha = .5) +
  labs(x = "Total XP", y = "XP Type (Regular or Double)", subtitle = "Boxplots Comparing XP Type and Total XP")
```
The boxplots show that there is a significant difference between the "regular" and "double" experience matches, with double experience matches generally yielding
more. Comparing the means and medians due to the right skew in double XP matches:
```{r}
reactable(scores_full %>%
  group_by(XPType) %>%
  summarise(
    "Median XP" = round(median(TotalXP), digits = 3),
    "Mean XP" = round(mean(TotalXP), digits = 3),
    ))
```

It seems to be the case that double XP matches actually result in double experience. This finding places doubt on the earlier research questions and the double experience matches should be accounted for.

Revisiting the first question regarding whether experience earned varies by game mode:

```{r}
ggplot(scores_full, aes(x = TotalXP, y = Game, color = Game)) + 
  geom_boxplot(alpha = .5) +
  facet_wrap(~ XPType) +
  labs(x = "Total Experience", y = "Game Type", subtitle = "Faceted Boxplots Comparing Game Type and Experience")
```
It seems that accounting for double experience cleaned up the plots, making the case stronger that total experience does not vary by game type.

Revisiting the second question regarding whether "core" or "hardcore" matches lead to more experience.

```{r}
ggplot(scores_full, aes(x = TotalXP, y = Mode, color = Mode)) + 
  geom_boxplot(alpha = .5) +
  facet_wrap(~ XPType) +
  labs(x = "Total Experience", y = "Game Mode", subtitle = "Faceted Boxplots Comparing Game Mode and Total Experience")
```

Again, accounting for double experience matches makes a stronger case that the total experience earned by a player does not vary with the game mode.

## Task 2

#### Discussion of Data Wrangling and Approach to PCA
As seen the initial research questions, there are many features and interactions in this data and further investigation into total experience needs to be conducted using principle component
analysis (PCA) to reduce the dimensional.

Prior to conducting PCA, however, decisions need to be made on how to manage the qualitative variables. Task 1 concluded with the game type and game mode not having 
an observable affect on the total experience, so those features will not be used. The XPType variable has a dramatic effect on total experience and will be encoded as a zero or one
for whether the match has double experience.

```{r}
scores_num <- scores_full %>%
  select(-Level, -FullPartial, -Mode, -Game) %>%
  mutate(XPType = ifelse(XPType == "Double", 1, 0))
reactable(scores_num)
```
```{r}
prcomp_res <- prcomp(x = scores_num, center = TRUE, scale. = TRUE)
```

#### Results

```{r, warning=FALSE}
PVE <- prcomp_res$sdev^2/sum(prcomp_res$sdev^2)
fviz_screeplot(X = prcomp_res, 
     geom = c("bar", "line"),
     choice = "variance",
     ncp = 7,
     addlabels = TRUE) +
  labs(x = "Principal Component",
       y = "Percentage of Variance Explained") +
  scale_y_continuous(limits = c(0,100))
```

```{r}
cumPVE_df <- data.frame(PC = 1:ncol(scores_num), CumVarExp = cumsum(PVE))

ggplot(data = cumPVE_df, mapping = aes(x = PC, y = CumVarExp)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(limits = c(0,1)) +
  labs(x = "Principal Components",
       y = "Cumulative Proportion of Variance Explained") +
  theme_bw()
```

The first four principle components explain `r round(cumPVE_df$CumVarExp[4], digits = 4) * 100`% of the variance based on the cumulative variance plot and should be sufficient.

```{r}
tidy(prcomp_res, matrix = "loadings") %>% 
  filter(PC %in% 1:4) %>%
  ggplot(aes(x = value, y = column)) +
  facet_wrap(~ PC) + 
  geom_col(aes(fill=column),show.legend = F)+
  labs(x= "Loadings",y="Predictors")+
  theme_bw()
```

Using approximately 0.5 as a significance threshold, the first principle component is most influenced by Total Experience and Eliminations. The second component is significantly influenced by the team scores and deaths. The third principle component is very influenced by XPType. Lastly the fourth principle component is very influenced by damage.

```{r,  warning=FALSE}
fviz_pca_biplot(prcomp_res, repel = TRUE,
                col.var = "#2E9FDF",
                col.ind = "#696969",
                geom.ind = "point")
```

The PCA Biplot shows that there is minimal correlation between features Score, TotalXP, XPType, Damage, and Eliminations compared to PlayerTeamScore, OpponentTeamScore, and Deaths. These vector angles seem to match the correlations from the earlier bi-variate plot.


```{r}
combined <- as.data.frame(prcomp_res$x[, 1:4])
combined$Game <- scores_full$Game
combined$Mode <- scores_full$Mode

ggplot(combined, aes(x = PC1, y = PC2, color = Mode, shape = Mode)) +
  geom_point(alpha = 0.7) +
  labs(
    x = paste("PC1 (", round(100 * PVE[1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * PVE[2], 1), "%)", sep = "")
  )

```

Coloring the PCA plot by mode shows that there not much of a difference in the experience related features between the different modes of core and hardcore.

```{r}
ggplot(combined, aes(x = PC1, y = PC2, color = Game, shape = Game)) +
  geom_point(alpha = 0.7) +
  labs(
    x = paste("PC1 (", round(100 * PVE[1], 1), "%)", sep = ""),
    y = paste("PC2 (", round(100 * PVE[2], 1), "%)", sep = "")
  )
```

The second PCA plot colored by game type shows that there is not a significant difference in the experience related features. However, the plot indicates that domination and hard point tend to have lower team scores and deaths.

## Task 3

#### Clustering on High Dimensional Data 

```{r}
scores_num <- scale(scores_num, center = TRUE, scale = TRUE)
fviz_nbclust(x = scores_num, FUNcluster = kmeans, 
             method = "wss", k.max = 15, 
             nstart = 25,
             iter.max = 15) + 
  labs(subtitle ="K-means")
```

```{r}
fviz_nbclust(x = scores_num, 
             FUNcluster = hcut, 
             method = "wss", 
             k.max = 15, 
             nstart = 25,
             iter.max = 15,
             hc_func = "hclust", 
             hc_metric = "euclidean",
             hc_method = "complete") +
  labs(subtitle ="Complete Linkage")
```

Elbow plots using hierarchical clustering and k-means with 15 clusters, 15 iterations, and 25 starts seems to indicate that 3 clusters is optimal.

```{r}
eucDist <- stats::dist(x = scores_num, method = "euclidean")
hcSing <- hclust(d = eucDist, method = "complete")
hd_clusters <- cutree(tree = hcSing, k = 3)
```

The elbow plot from hierarchical clustering was the clearest, so it will be the clustering method chosen for the high density data.


#### Clustering after PCA

```{r}
fviz_nbclust(x = as.data.frame(prcomp_res$x), FUNcluster = kmeans, 
             method = "wss", k.max = 15, 
             nstart = 25,
             iter.max = 15) + 
  labs(subtitle ="K-means")
```

```{r}
fviz_nbclust(x = as.data.frame(prcomp_res$x), 
             FUNcluster = hcut, 
             method = "wss", 
             k.max = 15, 
             nstart = 25,
             iter.max = 15,
             hc_func = "hclust", 
             hc_metric = "euclidean",
             hc_method = "complete") +
  labs(subtitle ="Complete Linkage")

eucDist <- stats::dist(x = as.data.frame(prcomp_res$x[,1:4]), method = "euclidean")
hcSing <- hclust(d = eucDist, method = "complete")
pca_clusters <- cutree(tree = hcSing, k = 3)
```

The same clustering parameters were used in the elbow plots for the PCA components 1 through 4. The k-means elbow plot does not provide a clear optimal number; however, the hierarchical clustering elbow plot suggests that the optimal number of clusters might be 3. 

#### Comparison of Results

```{r}

combined <- combined %>% 
  mutate(hd_cluster = hd_clusters) %>%
  mutate(pca_cluster = pca_clusters)

ggplot(combined, aes(x = PC1, y = PC2,
                   color = as.factor(hd_cluster),
                   shape = as.factor(hd_cluster))) + 
  geom_point(alpha = 0.6) +
    labs(x = paste("PC1 (", round(100*PVE[1], digits = 1), "%)", sep = ""),
       y = paste("PC2 (", round(100*PVE[2], digits = 1), "%)", sep = ""),
       color = "Cluster",
       shape = "Cluster") 

```

The hierarchical clustering seems to have results in clusters for low team scores and deaths matches, high experience matches, and low experience matches. Clusters 1 and 3 are mostly along the first principle component while the second cluster is along the second principle component.



```{r}
ggplot(combined, aes(x = PC1, y = PC2,
                   color = as.factor(pca_cluster),
                   shape = as.factor(pca_cluster))) + 
  geom_point(alpha = 0.6) +
    labs(x = paste("PC1 (", round(100*PVE[1], digits = 1), "%)", sep = ""),
       y = paste("PC2 (", round(100*PVE[2], digits = 1), "%)", sep = ""),
       color = "Cluster",
       shape = "Cluster") 
```

Clustering on the PCA data resulted in clusters in the same general locations, however the boundaries are different. Cluster 3 is now more distinct compared to clusters 1 and 2. Clusters 1 and 2 have significantly more overlap. 

```{r}
ari <- adjustedRandIndex(hd_clusters, pca_clusters)
ari
```
The adjusted rand index for similarity the labels from the high density clustering and the pca clustering is `r round(ari, digits = 3)`. The rand index ranges from 0 to 1 and the score of `r round(ari, digits = 3)` indicates low agreement between the label assignments (Fraley et al, 2025). 

### References

Fraley, C., Raftery, A., Scrucca, L., Murphy, T., Fop, M. (2025). _Gaussian Mixture Modeling_. Retrieved from: [r-cran](https://cran.r-project.org/web/packages/mclust/index.html)
